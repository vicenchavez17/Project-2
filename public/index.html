<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apparel recommender</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 32px;
        line-height: 1.5;
      }

      h1, h2 {
        margin-bottom: 8px;
      }

      form {
        margin-bottom: 12px;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      input[type="text"],
      input[type="email"],
      input[type="password"] {
        padding: 8px;
        min-width: 220px;
      }

      input[type="submit"],
      button {
        padding: 8px 12px;
      }

      #status {
        margin: 8px 0;
        color: #d64545;
      }

      #result {
        display: none;
        max-width: 500px;
        margin-top: 12px;
        border: 1px solid #ccc;
        padding: 8px;
      }

      #savedImages {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 12px;
        margin-top: 8px;
      }

      #savedImages img {
        width: 100%;
        border: 1px solid #e0e0e0;
        padding: 4px;
        box-sizing: border-box;
      }

      .muted {
        color: #666;
        margin-top: 4px;
      }
    </style>
  </head>

  <body>
    <h1>Log in to generate and save images</h1>

    <!-- Auth testing moved to `public/auth-test.html` -->

    <section>
      <h2>Generate apparel image</h2>
      <form id="uploadForm">
        <input type="file" name="image" accept="image/*" required>
        <input type="text" name="query" placeholder="e.g. shirt, pants, jacket">
        <input type="submit" value="Generate &amp; save">
      </form>
      <div id="status"></div>
      <img id="result" alt="Generated apparel result">
    </section>

    <section>
      <h2>Your saved images</h2>
      <div id="savedImages"></div>
      <p id="savedEmpty" class="muted">No saved images yet. Generate something to see it here.</p>
    </section>

    <script>
      const statusEl = document.getElementById('status');
      const resultEl = document.getElementById('result');
      const savedImagesContainer = document.getElementById('savedImages');
      const savedEmptyState = document.getElementById('savedEmpty');

      const setStatus = (message, color = '#d64545') => {
        statusEl.textContent = message;
        statusEl.style.color = color;
      };

      const renderSavedImages = (images) => {
        savedImagesContainer.innerHTML = '';
        const safeImages = Array.isArray(images) ? images.filter(Boolean) : [];

        if (safeImages.length === 0) {
          savedEmptyState.style.display = 'block';
          return;
        }

        savedEmptyState.style.display = 'none';
        safeImages.forEach((src) => {
          const img = document.createElement('img');
          img.src = src;
          img.alt = 'Saved apparel recommendation';
          savedImagesContainer.appendChild(img);
        });
      };

      const updateAuthUI = () => {};

      // Fetch images from server (GCS URLs) and display them
      const fetchAndDisplayServerImages = async () => {
        const token = localStorage.getItem('token');
        if (!token) {
          renderSavedImages([]);
          return;
        }

        try {
          const resp = await fetch('/images', {
            headers: { 'Authorization': `Bearer ${token}` }
          });

          if (!resp.ok) {
            console.warn('Failed to fetch images, status:', resp.status);
            renderSavedImages([]);
            return;
          }

          const data = await resp.json();
          if (!data || !Array.isArray(data.images)) {
            renderSavedImages([]);
            return;
          }

          const urls = data.images.map(i => i.url).filter(Boolean);
          renderSavedImages(urls);
        } catch (err) {
          console.warn('Failed to fetch server images:', err.message || err);
          renderSavedImages([]);
        }
      };

      fetchAndDisplayServerImages();

      // Logout handled in separate auth test page

      document.getElementById('uploadForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        statusEl.textContent = '';

        const token = localStorage.getItem('token');
        if (!token) {
          setStatus('Please log in or register first.');
          return;
        }

        const file = e.target.image.files[0];
        if (!file) {
          setStatus('Please choose an image first.');
          return;
        }

        const formData = new FormData();
        formData.append('image', file);
        formData.append('query', e.target.query.value);
        
        setStatus('Processing...', '#666');
        resultEl.style.display = 'none';

        try {
          const response = await fetch('/recommend', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` },
            body: formData
          });
          
          if (response.ok) {
            const data = await response.json();
            resultEl.src = 'data:image/png;base64,' + data.image;
            resultEl.style.display = 'block';
            setStatus('Success!', '#28a745');
            fetchAndDisplayServerImages();
          } else {
            const error = await response.json();
            setStatus(`Error: ${error.error || 'Failed to generate image.'}`);
          }
        } catch (error) {
          setStatus(`Failed: ${error.message}`);
        }
      });

      // Register / Login handled in separate auth test page
    </script>
  </body>
</html>